#cloud-config

# FDS Instance Setup
# This cloud-init file installs all dependencies and FDS software

package_update: true
package_upgrade: false

packages:
  - build-essential
  - openmpi-bin
  - libopenmpi-dev
  - libncurses6
  - tmux
  - jq
  - unzip
  - wget
  - curl
  - gnupg
  - libfuse2t64
  - inotify-tools
  - rsync

write_files:
  - path: /tmp/ghostty.terminfo
    permissions: '0644'
    content: |
      xterm-ghostty|ghostty|Ghostty,
      	am, bce, ccc, hs, km, mc5i, mir, msgr, npc, xenl,
      	colors#0x100, cols#80, it#8, lines#24, pairs#0x7fff,
      	acsc=++\,\,--..00``aaffgghhiijjkkllmmnnooppqqrrssttuuvvwwxxyyzz{{||}}~~,
      	bel=^G, blink=\E[5m, bold=\E[1m, cbt=\E[Z, civis=\E[?25l,
      	clear=\E[H\E[2J, cnorm=\E[?12l\E[?25h, cr=\r,
      	csr=\E[%i%p1%d;%p2%dr, cub=\E[%p1%dD, cub1=^H,
      	cud=\E[%p1%dB, cud1=\n, cuf=\E[%p1%dC, cuf1=\E[C,
      	cup=\E[%i%p1%d;%p2%dH, cuu=\E[%p1%dA, cuu1=\E[A,
      	cvvis=\E[?12;25h, dch=\E[%p1%dP, dch1=\E[P, dim=\E[2m,
      	dl=\E[%p1%dM, dl1=\E[M, dsl=\E]2;\007, ech=\E[%p1%dX,
      	ed=\E[J, el=\E[K, el1=\E[1K, flash=\E[?5h$<100/>\E[?5l,
      	fsl=^G, home=\E[H, hpa=\E[%i%p1%dG, ht=^I, hts=\EH,
      	ich=\E[%p1%d@, ich1=\E[@, il=\E[%p1%dL, il1=\E[L, ind=\n,
      	indn=\E[%p1%dS,
      	initc=\E]4;%p1%d;rgb:%p2%{255}%*%{1000}%/%2.2X/%p3%{255}%*%{1000}%/%2.2X/%p4%{255}%*%{1000}%/%2.2X\E\\,
      	invis=\E[8m, kDC=\E[3;2~, kEND=\E[1;2F, kHOM=\E[1;2H,
      	kIC=\E[2;2~, kLFT=\E[1;2D, kNXT=\E[6;2~, kPRV=\E[5;2~,
      	kRIT=\E[1;2C, kbs=^?, kcbt=\E[Z, kcub1=\EOD, kcud1=\EOB,
      	kcuf1=\EOC, kcuu1=\EOA, kdch1=\E[3~, kend=\EOF, kent=\EOM,
      	kf1=\EOP, kf10=\E[21~, kf11=\E[23~, kf12=\E[24~,
      	kf13=\E[1;2P, kf14=\E[1;2Q, kf15=\E[1;2R, kf16=\E[1;2S,
      	kf17=\E[15;2~, kf18=\E[17;2~, kf19=\E[18;2~, kf2=\EOQ,
      	kf20=\E[19;2~, kf21=\E[20;2~, kf22=\E[21;2~,
      	kf23=\E[23;2~, kf24=\E[24;2~, kf25=\E[1;5P, kf26=\E[1;5Q,
      	kf27=\E[1;5R, kf28=\E[1;5S, kf29=\E[15;5~, kf3=\EOR,
      	kf30=\E[17;5~, kf31=\E[18;5~, kf32=\E[19;5~,
      	kf33=\E[20;5~, kf34=\E[21;5~, kf35=\E[23;5~,
      	kf36=\E[24;5~, kf37=\E[1;6P, kf38=\E[1;6Q, kf39=\E[1;6R,
      	kf4=\EOS, kf40=\E[1;6S, kf41=\E[15;6~, kf42=\E[17;6~,
      	kf43=\E[18;6~, kf44=\E[19;6~, kf45=\E[20;6~,
      	kf46=\E[21;6~, kf47=\E[23;6~, kf48=\E[24;6~,
      	kf49=\E[1;3P, kf5=\E[15~, kf50=\E[1;3Q, kf51=\E[1;3R,
      	kf52=\E[1;3S, kf53=\E[15;3~, kf54=\E[17;3~,
      	kf55=\E[18;3~, kf56=\E[19;3~, kf57=\E[20;3~,
      	kf58=\E[21;3~, kf59=\E[23;3~, kf6=\E[17~, kf60=\E[24;3~,
      	kf61=\E[1;4P, kf62=\E[1;4Q, kf63=\E[1;4R, kf7=\E[18~,
      	kf8=\E[19~, kf9=\E[20~, khome=\EOH, kich1=\E[2~,
      	kind=\E[1;2B, kmous=\E[<, knp=\E[6~, kpp=\E[5~,
      	kri=\E[1;2A, oc=\E]104\007, op=\E[39;49m, rc=\E8,
      	rep=%p1%c\E[%p2%{1}%-%db, rev=\E[7m, ri=\EM,
      	rin=\E[%p1%dT, ritm=\E[23m, rmacs=\E(B, rmam=\E[?7l,
      	rmcup=\E[?1049l, rmir=\E[4l, rmkx=\E[?1l\E>, rmso=\E[27m,
      	rmul=\E[24m, rs1=\E]\E\\\Ec, sc=\E7,
      	setab=\E[%?%p1%{8}%<%t4%p1%d%e%p1%{16}%<%t10%p1%{8}%-%d%e48;5;%p1%d%;m,
      	setaf=\E[%?%p1%{8}%<%t3%p1%d%e%p1%{16}%<%t9%p1%{8}%-%d%e38;5;%p1%d%;m,
      	sgr=%?%p9%t\E(0%e\E(B%;\E[0%?%p6%t;1%;%?%p2%t;4%;%?%p1%p3%|%t;7%;%?%p4%t;5%;%?%p7%t;8%;m,
      	sgr0=\E(B\E[m, sitm=\E[3m, smacs=\E(0, smam=\E[?7h,
      	smcup=\E[?1049h, smir=\E[4h, smkx=\E[?1h\E=, smso=\E[7m,
      	smul=\E[4m, tbc=\E[3g, tsl=\E]2;, u6=\E[%i%d;%dR, u7=\E[6n,
      	u8=\E[?%[;0123456789]c, u9=\E[c, vpa=\E[%i%p1%dd,
  - path: /tmp/install-fds.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euxo pipefail

      tic -x /tmp/ghostty.terminfo || true
      rm -f /tmp/ghostty.terminfo

      LATEST_URL=$(curl -s --retry 3 --retry-delay 1 --max-time 10 https://api.github.com/repos/firemodels/fds/releases/latest | jq -r '.assets[] | select(.name | endswith("_lnx.sh")) | .browser_download_url')
      curl -L --retry 3 --retry-delay 1 --max-time 300 -o /tmp/fds_installer.sh "$LATEST_URL"
      chmod +x /tmp/fds_installer.sh

      su - ubuntu -c "cd /tmp && ./fds_installer.sh y"

      grep -q "FDS6VARS.sh" /home/ubuntu/.bashrc || echo "source /home/ubuntu/FDS/FDS6/bin/FDS6VARS.sh" >> /home/ubuntu/.bashrc
      chown ubuntu:ubuntu /home/ubuntu/.bashrc

      rm -f /tmp/fds_installer.sh
  - path: /tmp/install-mountpoint-s3.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euxo pipefail

      ARCH=$(uname -m)
      if [ "$ARCH" = "aarch64" ]; then
        ARCH="arm64"
      fi

      # Get DEB and signature URLs
      RELEASE_BODY=$(curl -s --retry 3 --retry-delay 1 --max-time 10 https://api.github.com/repos/awslabs/mountpoint-s3/releases/latest | jq -r '.body')
      DEB_URL=$(echo "$RELEASE_BODY" | grep -o 'https://[^ ]*' | grep '\.deb' | grep -v '\.asc' | grep "$ARCH" | tr -d '\r')
      SIG_URL="${DEB_URL}.asc"

      # Download package and signature
      curl -L --retry 3 --retry-delay 1 --max-time 60 -o /tmp/mount-s3.deb "$DEB_URL"
      curl -L --retry 3 --retry-delay 1 --max-time 60 -o /tmp/mount-s3.deb.asc "$SIG_URL"

      # Import and verify AWS mountpoint-s3 public key
      curl -L --retry 3 --retry-delay 1 --max-time 60 -o /tmp/mountpoint-keys https://s3.amazonaws.com/mountpoint-s3-release/public_keys/KEYS
      gpg --import /tmp/mountpoint-keys

      # Verify signature
      gpg --verify /tmp/mount-s3.deb.asc /tmp/mount-s3.deb

      # Install package
      dpkg -i /tmp/mount-s3.deb

      # Cleanup
      rm -f /tmp/mount-s3.deb /tmp/mount-s3.deb.asc /tmp/mountpoint-keys

      mkdir -p /mnt/fds-output
      chown ubuntu:ubuntu /mnt/fds-output
  - path: /usr/local/bin/sync-to-s3.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euo pipefail

      # Sync script that watches a local directory and copies changed files to S3 mount
      # Usage: sync-to-s3.sh <local_dir> <s3_mount_dir>

      if [ "$#" -ne 2 ]; then
          echo "Usage: $0 <local_dir> <s3_mount_dir>"
          exit 1
      fi

      LOCAL_DIR="$1"
      S3_MOUNT_DIR="$2"

      echo "Starting file sync: $LOCAL_DIR -> $S3_MOUNT_DIR"

      # Create S3 directory if it doesn't exist
      mkdir -p "$S3_MOUNT_DIR"

      # Initial sync of existing files
      echo "Performing initial sync..."
      rsync -rlv --ignore-existing "$LOCAL_DIR/" "$S3_MOUNT_DIR/"

      # Watch for file changes and sync
      inotifywait -m -r -e close_write,moved_to,create "$LOCAL_DIR" --format '%w%f' | while read -r FILE
      do
          # Get relative path
          REL_PATH="${FILE#"$LOCAL_DIR"/}"

          # Skip if it's a directory
          if [ -d "$FILE" ]; then
              mkdir -p "$S3_MOUNT_DIR/$REL_PATH"
              continue
          fi

          # Copy file to S3 mount
          DEST_DIR=$(dirname "$S3_MOUNT_DIR/$REL_PATH")
          mkdir -p "$DEST_DIR"

          echo "Syncing: $REL_PATH"
          cp -f "$FILE" "$S3_MOUNT_DIR/$REL_PATH"
      done
  - path: /etc/systemd/system/mount-s3.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Mount S3 bucket using mountpoint-s3
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=forking
      User=ubuntu
      Group=ubuntu
      ExecStart=/usr/bin/mount-s3 --region us-east-1 --allow-overwrite --allow-delete fds-output-wang-fuk-fire /mnt/fds-output
      ExecStartPost=/bin/sh -c 'timeout 30 sh -c "while ! mountpoint -q /mnt/fds-output; do sleep 1; done"'
      ExecStop=/usr/bin/umount /mnt/fds-output
      Restart=on-failure
      RestartSec=10

      [Install]
      WantedBy=multi-user.target
  - path: /etc/systemd/system/fds-sync.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Sync FDS output to S3
      After=mount-s3.service
      Requires=mount-s3.service

      [Service]
      Type=simple
      User=ubuntu
      Group=ubuntu
      ExecStart=/usr/local/bin/sync-to-s3.sh /home/ubuntu/fds-work /mnt/fds-output
      Restart=on-failure
      RestartSec=5

      [Install]
      WantedBy=multi-user.target

runcmd:
  - /tmp/install-fds.sh
  - /tmp/install-mountpoint-s3.sh
  - mkdir -p /home/ubuntu/fds-work
  - chown ubuntu:ubuntu /home/ubuntu/fds-work
  - systemctl daemon-reload
  - systemctl enable mount-s3.service
  - systemctl enable fds-sync.service
  - systemctl start mount-s3.service
  - systemctl start fds-sync.service

final_message: "FDS instance setup complete. Check /var/log/cloud-init-output.log for details."
